<!DOCTYPE html>
<html lang="fi">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Olli Maula">
    <meta charset="UTF-8">
    <title>Olli Maula - Harjoitus 4</title>
</head>
<body style="margin-bottom: 15em;">

    <div class="H4T1" style="float: left; border-right: solid; margin-right: 0.5em;"> 

        <p>Harjoitus 4 Tehtävä 1</p>

        <div id="houses"></div>

        <link rel="stylesheet" media="all" href="styles/h4t1.css"> 
        <script src="jscript/h4t1.js"></script>
        <script id="H4T1">renderHouses()</script>

    </div>

    <div class="H4T2"> 

        <p>Harjoitus 4 Tehtävä 2</p>

        <input type="checkbox" id="size_limit" onclick="renderHouses_2()">
        <label for="size_limit"> alle 200m2</label><br>
        <input type="checkbox" id="price_limit" onclick="renderHouses_2()">
        <label for="price_limit"> alle 1 000 000 euroa</label><br>

        <div id="houses_2"></div>

        <link rel="stylesheet" media="all" href="styles/h4t2.css"> 
        <script src="jscript/h4t2.js"></script>
        <script id="H4T2">renderHouses_2()</script>

    </div>

    <div class="H4T3"> 

        <hr>
        <p>
            Harjoitus 4 Tehtävä 3 |
            <input type="checkbox" id="scroll_lock" onclick="scroll_lock_listener()">
            <label for="scroll_lock"> Keskeytä nuolinäppäinten vieritys.</label> 
            <!-- Keskeyttää ikkunan scrollaamisen nuolinäppäimiä painettaessa. Testailua varten. --> 
        </p>

        <h2>fetchAPI - SearchForm</h2>
        <div id="search_form">
            <input type="text" id="ns_bar" onkeyup="search_names()">
            <ul id="name_list"></ul>
        </div>
        
        <script id="H4T3">

            // tarvittavat muuttujat listan scrollaamista varten
            var elements, current, max;

            document.addEventListener("keydown", e => {
                if (e.key == "Escape") {
                    document.getElementById("name_list").innerHTML = ""; // hävitetään hakutulokset
                    document.getElementById("ns_bar").value = ""; // tyhjennetään hakukenttä
                };
            });

            document.addEventListener("keydown", e => {
                if (e.key == "ArrowDown") {
                    if (current < max -1) { // -1 off-by-one ongelman välttämiseksi
                        elements[++current].focus();
                    };
                };
            });

            document.addEventListener("keydown", e => {
                if (e.key == "ArrowUp") {
                    if (current > 0) {
                        elements[--current].focus();
                    };
                };
            });

            document.addEventListener("keydown", e => {
                if (e.key == "Enter") {
                    if (document.getElementById("name_list").contains(document.activeElement)) {
                        document.getElementById("ns_bar").value = document.activeElement.innerHTML; // päivitetään hakukenttä aktiivisella elementillä
                        document.getElementById("name_list").innerHTML = ""; // hävitetään hakutulokset
                    }
                    else {
                        document.getElementById("name_list").innerHTML = ""; // hävitetään hakutulokset
                        document.getElementById("ns_bar").value = ""; // tyhjennetään hakukenttä
                    }
                };
            });

            async function get_namelist() {
                try {
                    let res = await fetch('nimet.json');
                    return await res.json();
                } 
                catch (error) {
                    console.log(error);
                }
            };

            async function search_names() {

                let names = await get_namelist();

                search_term = '^' + document.getElementById("ns_bar").value; // valmistellaan greppi
                var get_list = document.getElementById("name_list");
                get_list.innerHTML = ""; // hävitetään mahdolliset aiemmat tulokset

                // nollataan scroll muuttujat
                elements = [];
                current = -1;
                max = 0;

                if (!(search_term == '^')) {

                    let regex = new RegExp(search_term, 'gi');
                    names = names.filter(names => names.match(regex)); // muodostetaan lista uudestaan pelkästään halutuista tuloksista
                
                    names.forEach(element => {
                        
                        let name = document.createElement('li');
                        name.tabIndex = 0; // mahdollistetaan li elementin focus
                        name.style.maxWidth = "5em";
                        let name_print = document.createTextNode(element); 

                        name.appendChild(name_print); 
                        get_list.appendChild(name);

                        elements.push(name); // kasataan nimistä scrollattava lista
                        max = elements.length;

                    });

                };

            };

            // nuolinäppäinten scroll lock harjoituksen helpompaa käyttöä varten jos ikkuna on pieni

            function scroll_lock_listener() {

                if (document.getElementById('scroll_lock').checked) {
                    window.addEventListener("keydown", scroll_lock)
                }
                else {
                    window.removeEventListener("keydown", scroll_lock)
                };
            };

            function scroll_lock(e) {
                if (["ArrowUp", "ArrowDown"].indexOf(e.code) > -1) {
                    e.preventDefault();
                }
            };

            

        </script>

        <style>

            /* tyylit focusta varten */

            li:focus {
                background-color: lightgreen;
            }
            
            li:not(:focus) {
                background-color: none;
            }

        </style>

    </div>

</body>
</html>
